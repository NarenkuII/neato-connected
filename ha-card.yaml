type: vertical-stack
variables:
  project: philip2809.neato-connected
  version: 1.1.1.1
cards:
  - type: custom:button-card
    variables:
      robot_id: neato_vacuum
    icon: mdi:robot-vacuum-variant
    entity: "[[[ return `sensor.${variables.robot_id}_robot_error`; ]]]"
    size: 50%
    color_type: icon
    tap_action:
      action: none
    hold_action:
      action: none
    double_tap_action:
      action: none
    name: |
      [[[ 
        const uiState = states[`sensor.${variables.robot_id}_ui_state`]?.state || '';
        if (uiState.includes('STATE_IDLE')) return 'Inactif';
        else if (uiState.includes('STATE_STANDBY')) return 'Veille';
        else if (uiState.includes('STATE_TESTMODE')) return 'Mode test activé !';
        else if (uiState.includes('STATE_USB_LOGCOPY')) return 'Copie des journaux sur USB';
        else if (uiState.includes('STATE_STARTHOUSECLEANING')) return 'Démarrage du nettoyage complet';
        else if (uiState.includes('STATE_HOUSECLEANINGRUNNING')) return 'Nettoyage complet en cours';
        else if (uiState.includes('STATE_HOUSECLEANINGPAUSED')) return 'Nettoyage complet en pause';
        else if (uiState.includes('STATE_STARTSPOTCLEANING')) return 'Démarrage du nettoyage ciblé';
        else if (uiState.includes('STATE_SPOTCLEANINGRUNNING')) return 'Nettoyage ciblé en cours';
        else if (uiState.includes('STATE_SPOTCLEANINGPAUSED')) return 'Nettoyage ciblé en pause';
        else return uiState || 'Inconnu';
      ]]]
    styles:
      icon:
        - color: |
            [[[ 
              const uiState = states[`sensor.${variables.robot_id}_ui_state`]?.state || '';
              if (uiState === "Starting...") return '#edb926';
              if (uiState === "Shutting down...") return 'gray';
              const err = states[`sensor.${variables.robot_id}_robot_error`]?.state || '';
              if (!err.startsWith('200')) return '#950606';
              const alert = states[`sensor.${variables.robot_id}_robot_alert`]?.state || '';
              if (!alert.startsWith('200')) return '#edb926';
              return '#00cc00';
            ]]]
      card:
        - border-radius: 20px
        - display: flex
        - justify-content: center
        - align-items: center
        - margin: 0 auto
        - position: relative
      custom_fields:
        battery:
          - position: absolute
          - top: 8px
          - right: 8px
          - padding: 4px 8px
          - border-radius: 8px
          - font-weight: bold
          - animation: |
              [[[ 
                if (states[`binary_sensor.${variables.robot_id}_charging_active`]?.state !== 'on') return '';
                const pct = Number(states[`sensor.${variables.robot_id}_fuel_percent`]?.state);
                return pct > 35 ? 'pulseGreen 3s infinite' : 'pulseOrange 3s infinite';
              ]]]
          - background-color: |
              [[[ 
                const pct = Number(states[`sensor.${variables.robot_id}_fuel_percent`]?.state);
                return pct > 35 ? 'rgb(124, 252, 0)' : 'rgb(255, 140, 0)';
              ]]]
          - color: black
        dock:
          - position: absolute
          - top: 8px
          - left: 8px
          - padding: 4px
          - border-radius: 8px
          - background-color: rgba(255,255,255,0.2)
          - display: |
              [[[ 
                return states[`binary_sensor.${variables.robot_id}_ext_power_present`]?.state === 'on'
                  ? 'block'
                  : 'none';
              ]]]
    custom_fields:
      battery: |-
        [[[ 
          const v = states[`sensor.${variables.robot_id}_fuel_percent`]?.state;
          return (v ?? '0') + '%';
        ]]]
      dock: |
        [[[ 
          if (states[`binary_sensor.${variables.robot_id}_ext_power_present`]?.state === 'on') {
            return 'SUR BASE';
          } else {
            return '';
          }
        ]]]
    extra_styles: |
      @keyframes pulseGreen {
        0%   { box-shadow: 0 0 5px 0    rgba(124, 252, 0, 0.6); }
        50%  { box-shadow: 0 0 20px 6px rgba(124, 252, 0, 1.0); }
        100% { box-shadow: 0 0 5px 0    rgba(124, 252, 0, 0.6); }
      }
      @keyframes pulseOrange {
        0%   { box-shadow: 0 0 5px 0    rgba(255, 140, 0, 0.6); }
        50%  { box-shadow: 0 0 20px 6px rgba(255, 140, 0, 1.0); }
        100% { box-shadow: 0 0 5px 0    rgba(255, 140, 0, 0.6); }
      }
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            variables:
              robot_id: neato_vacuum
            show_icon: false
            entity: "[[[ return `sensor.${variables.robot_id}_robot_alert`; ]]]"
            show_state: false
            styles:
              card:
                - border-color: |
                    [[[ 
                      const alert = states[`sensor.${variables.robot_id}_robot_alert`]?.state || '';
                      return alert.startsWith('200') ? '' : '#edb926';
                    ]]]
            name: |
              [[[ 
                const alert = states[`sensor.${variables.robot_id}_robot_alert`]?.state || '';
                if (alert.startsWith('200')) return 'Aucune alerte';
                try { return alert.match(/\(UI_(ERROR|ALERT)_(.+)\)/)[2].replaceAll('_',' '); }
                catch { return alert; }
              ]]]
          - type: custom:button-card
            variables:
              robot_id: neato_vacuum
            show_icon: false
            entity: "[[[ return `sensor.${variables.robot_id}_robot_error`; ]]]"
            show_state: false
            styles:
              card:
                - border-color: |
                    [[[ 
                      const err = states[`sensor.${variables.robot_id}_robot_error`]?.state || '';
                      return err.startsWith('200') ? '' : '#950606';
                    ]]]
            name: |
              [[[ 
                const err = states[`sensor.${variables.robot_id}_robot_error`]?.state || '';
                if (err.startsWith('200')) return 'Aucune erreur';
                try { return err.match(/\(UI_(ERROR|ALERT)_(.+)\)/)[2].replaceAll('_',' '); }
                catch { return err; }
              ]]]
  - type: horizontal-stack
    cards:
      - type: conditional
        conditions:
          - condition: and
            conditions:
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state_not: UIMGR_STATE_HOUSECLEANINGPAUSED
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state_not: UIMGR_STATE_HOUSECLEANINGRUNNING
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state_not: UIMGR_STATE_SPOTCLEANINGPAUSED
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state_not: UIMGR_STATE_SPOTCLEANINGRUNNING
        card:
          type: custom:button-card
          variables:
            robot_id: neato_vacuum
          entity: "[[[ return `button.${variables.robot_id}_house_clean`; ]]]"
          name: Nettoyer
          tap_action:
            action: toggle
      - type: conditional
        conditions:
          - condition: or
            conditions:
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state: UIMGR_STATE_HOUSECLEANINGPAUSED
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state: UIMGR_STATE_SPOTCLEANINGPAUSED
        card:
          type: custom:button-card
          variables:
            robot_id: neato_vacuum
          entity: "[[[ return `button.${variables.robot_id}_resume_cleaning`; ]]]"
          name: Reprendre
          tap_action:
            action: toggle
      - type: conditional
        conditions:
          - condition: or
            conditions:
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state: UIMGR_STATE_HOUSECLEANINGRUNNING
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state: UIMGR_STATE_SPOTCLEANINGRUNNING
        card:
          type: custom:button-card
          variables:
            robot_id: neato_vacuum
          entity: "[[[ return `button.${variables.robot_id}_pause_cleaning`; ]]]"
          name: Pause
          tap_action:
            action: toggle
      - type: conditional
        conditions:
          - condition: and
            conditions:
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state_not: UIMGR_STATE_HOUSECLEANINGPAUSED
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state_not: UIMGR_STATE_HOUSECLEANINGRUNNING
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state_not: UIMGR_STATE_SPOTCLEANINGPAUSED
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state_not: UIMGR_STATE_SPOTCLEANINGRUNNING
        card:
          type: custom:button-card
          variables:
            robot_id: neato_vacuum
          entity: "[[[ return `button.${variables.robot_id}_spot_clean`; ]]]"
          name: Zone
          tap_action:
            action: toggle
          hold_action:
            action: fire-dom-event
            browser_mod:
              service: browser_mod.popup
              data:
                title: Nettoyage ciblé - Taille
                size: normal
                content:
                  type: vertical-stack
                  cards:
                    - type: entities
                      entities:
                        - entity: number.neato_vacuum_spot_clean_height
                          name: Hauteur
                          icon: mdi:arrow-up-down
                        - entity: number.neato_vacuum_spot_clean_width
                          name: Largeur
                          icon: mdi:arrow-left-right
                    - type: custom:button-card
                      size: 20%
                      name: Démarrer le nettoyage ciblé
                      entity: button.neato_vacuum_spot_clean_height_width
                      tap_action:
                        action: toggle
      - type: conditional
        conditions:
          - condition: or
            conditions:
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state: UIMGR_STATE_HOUSECLEANINGPAUSED
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state: UIMGR_STATE_SPOTCLEANINGPAUSED
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state: UIMGR_STATE_HOUSECLEANINGRUNNING
              - condition: state
                entity: sensor.neato_vacuum_ui_state
                state: UIMGR_STATE_SPOTCLEANINGRUNNING
        card:
          type: custom:button-card
          variables:
            robot_id: neato_vacuum
          entity: "[[[ return `button.${variables.robot_id}_stop_cleaning`; ]]]"
          name: ARRÊT
          tap_action:
            action: toggle
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        variables:
          robot_id: neato_vacuum
        entity: "[[[ return `button.${variables.robot_id}_locate_robot`; ]]]"
        name: Localiser
        tap_action:
          action: toggle
      - type: custom:button-card
        variables:
          robot_id: neato_vacuum
        name: Manuel
        icon: mdi:controller-classic
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              title: Contrôle Manuel
              size: normal
              content:
                type: vertical-stack
                cards:
                  - type: markdown
                    content: >
                      **Attention:** Vous devez activer le **Mode Test** pour
                      utiliser les commandes manuelles. Le robot ne nettoiera
                      pas automatiquement tant que ce mode est actif.
                  - type: entities
                    entities:
                      - entity: switch.neato_vacuum_test_mode
                        name: Mode Test (Requis)
                  - type: conditional
                    conditions:
                      - condition: state
                        entity: switch.neato_vacuum_test_mode
                        state: "on"
                    card:
                      type: vertical-stack
                      cards:
                        - type: entities
                          entities:
                            - entity: number.neato_vacuum_manual_step_distance
                              name: Distance pas à pas (mm)
                            - entity: number.neato_vacuum_manual_turn_angle
                              name: Angle de virage (deg)
                            - entity: number.neato_vacuum_manual_drive_speed
                              name: Vitesse de déplacement
                        - type: horizontal-stack
                          cards:
                            - type: custom:button-card
                              color_type: blank-card
                            - type: custom:button-card
                              entity: button.neato_vacuum_manual_forward
                              icon: mdi:arrow-up-bold
                              name: Avancer
                              tap_action:
                                action: call-service
                                service: button.press
                                service_data:
                                  entity_id: button.neato_vacuum_manual_forward
                            - type: custom:button-card
                              color_type: blank-card
                        - type: horizontal-stack
                          cards:
                            - type: custom:button-card
                              entity: button.neato_vacuum_manual_left
                              icon: mdi:arrow-left-bold
                              name: Gauche
                              tap_action:
                                action: call-service
                                service: button.press
                                service_data:
                                  entity_id: button.neato_vacuum_manual_left
                            - type: custom:button-card
                              entity: button.neato_vacuum_manual_stop
                              icon: mdi:stop
                              name: STOP
                              color: red
                              tap_action:
                                action: call-service
                                service: button.press
                                service_data:
                                  entity_id: button.neato_vacuum_manual_stop
                            - type: custom:button-card
                              entity: button.neato_vacuum_manual_right
                              icon: mdi:arrow-right-bold
                              name: Droite
                              tap_action:
                                action: call-service
                                service: button.press
                                service_data:
                                  entity_id: button.neato_vacuum_manual_right
                        - type: horizontal-stack
                          cards:
                            - type: custom:button-card
                              entity: button.neato_vacuum_manual_turn_180
                              icon: mdi:rotate-3d-variant
                              name: 180°
                              tap_action:
                                action: call-service
                                service: button.press
                                service_data:
                                  entity_id: button.neato_vacuum_manual_turn_180
                            - type: custom:button-card
                              entity: button.neato_vacuum_manual_reverse
                              icon: mdi:arrow-down-bold
                              name: Reculer
                              tap_action:
                                action: call-service
                                service: button.press
                                service_data:
                                  entity_id: button.neato_vacuum_manual_reverse
                            - type: custom:button-card
                              color_type: blank-card
                        - type: entities
                          title: Outils de nettoyage
                          entities:
                            - entity: switch.neato_vacuum_manual_vacuum
                              name: Aspiration
                            - entity: number.neato_vacuum_manual_vacuum_power
                              name: Puissance Aspiration (%)
                            - type: divider
                            - entity: switch.neato_vacuum_manual_main_brush
                              name: Brosse Principale
                            - entity: number.neato_vacuum_manual_brush_rpm
                              name: Vitesse Brosse (RPM)
                            - type: divider
                            - entity: switch.neato_vacuum_manual_side_brush
                              name: Brosse Latérale
                        - type: entities
                          entities:
                            - entity: text.neato_vacuum_send_command
                              name: Injecter une commande
                              icon: mdi:console
      - type: custom:button-card
        variables:
          robot_id: neato_vacuum
        name: Paramètres
        icon: mdi:cog
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              title: Plus d'options
              size: normal
              content:
                type: vertical-stack
                cards:
                  - type: horizontal-stack
                    cards:
                      - show_name: true
                        show_icon: true
                        entity: >-
                          [[[ return `switch.${variables.robot_id}_eco_mode`;
                          ]]]
                        name: Mode ÉCO
                        type: button
                      - show_name: true
                        show_icon: true
                        entity: >-
                          [[[ return `switch.${variables.robot_id}_test_mode`;
                          ]]]
                        name: Mode Test
                        type: button
                      - entity: >-
                          [[[ return
                          `button.${variables.robot_id}_update_status`; ]]]
                        name: Actualiser
                        show_icon: true
                        type: button
                        tap_action:
                          action: toggle
                      - entity: >-
                          [[[ return
                          `binary_sensor.${variables.robot_id}_usb_connected`;
                          ]]]
                        name: USB
                        show_icon: true
                        type: button
                  - type: entities
                    entities:
                      - entity: >-
                          [[[ return
                          `select.${variables.robot_id}_navigation_mode`; ]]]
                        name: Mode de Navigation
                      - entity: >-
                          [[[ return
                          `switch.${variables.robot_id}_intenseclean`; ]]]
                        name: Nettoyage Intensif
                      - entity: "[[[ return `switch.${variables.robot_id}_led`; ]]]"
                        name: LED
                      - entity: "[[[ return `switch.${variables.robot_id}_wifi`; ]]]"
                        name: WiFi
                      - entity: >-
                          [[[ return `switch.${variables.robot_id}_wall_enable`;
                          ]]]
                        name: Suivi de mur
                      - entity: >-
                          [[[ return
                          `switch.${variables.robot_id}_melody_sounds`; ]]]
                        name: Mélodies
                      - entity: >-
                          [[[ return
                          `switch.${variables.robot_id}_warning_sounds`; ]]]
                        name: Alertes sonores
                      - entity: >-
                          [[[ return
                          `switch.${variables.robot_id}_click_sounds`; ]]]
                        name: Sons de clic
                      - entity: >-
                          [[[ return
                          `switch.${variables.robot_id}_bin_full_detect`; ]]]
                        name: Détection bac plein
                      - entity: >-
                          [[[ return `switch.${variables.robot_id}_schedule`;
                          ]]]
                        name: Programmation
                    state_color: false
                    show_header_toggle: false
                  - type: entities
                    entities:
                      - entity: "[[[ return `sensor.${variables.robot_id}_model`;]]]"
                        name: Modèle
                      - entity: >-
                          [[[ return
                          `sensor.${variables.robot_id}_serial_number`;]]]
                        name: S/N
                      - entity: >-
                          [[[ return
                          `sensor.${variables.robot_id}_time_local`;]]]
                        name: Heure du Robot
                      - entity: >-
                          [[[ return
                          `sensor.${variables.robot_id}_battery_voltage_v`;]]]
                        name: Tension Batterie
                      - entity: >-
                          [[[ return
                          `sensor.${variables.robot_id}_battery_temp_c_avg`;]]]
                        name: Temp. Batterie (moy)
                      - entity: >-
                          [[[ return
                          `sensor.${variables.robot_id}_battery_cycles`;]]]
                        name: Cycles Batterie
                      - entity: >-
                          [[[ return
                          `sensor.${variables.robot_id}_charger_mah`;]]]
                        name: Intensité Charge
                      - entity: >-
                          [[[ return
                          `sensor.${variables.robot_id}_discharge_mah`;]]]
                        name: Intensité Décharge
                  - type: horizontal-stack
                    cards:
                      - show_name: true
                        show_icon: true
                        entity: "[[[ return `button.${variables.robot_id}_shutdown`;]]]"
                        type: button
                        name: Éteindre
                        tap_action:
                          action: toggle
                      - show_name: true
                        show_icon: true
                        entity: >-
                          [[[ return
                          `button.${variables.robot_id}_powercycle`;]]]
                        name: Redémarrer Robot
                        type: button
                        tap_action:
                          action: toggle
                      - show_name: true
                        show_icon: true
                        type: button
                        entity: >-
                          [[[ return
                          `button.${variables.robot_id}_reboot_esp`;]]]
                        name: Redémarrer ESP
                        tap_action:
                          action: toggle
